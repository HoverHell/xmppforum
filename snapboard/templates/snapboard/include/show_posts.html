{% load i18n %}
{% load extras %}
{% load avatar_tags %}
{% load i18n pagination_tags %}
<div>
<div id="snap_top_post" class="snap_top_post">
    <div id="snap_post{{ top_post.id }}" class="snap_post">
        {% if top_post.censor %}<div class="post_censored">{% else %}{% ifnotequal top_post.abuse 0 %}<div class="post_reported">{% endifnotequal %}{% endif %}
        <div id="post_rpc_feedback{{ top_post.id }}" class="rpc_message">
            <!-- This DIV is for RPC feedback messages for individual posts -->
        </div>
        <div class="post_header">
            <div class="userpic_wrap">{% avatar top_post.user %}</div>
            <span class="post_menuright">
                {% if user.is_authenticated  %}
                    <span class="popup"><a href="{% url snapboard_post_reply top_post.id %}" onclick="return show_reply_form('{{ top_post.id }}');">{% trans "reply" %}</a></span>
                {% endif %}
                {% ifequal top_post.user_id user.id %}<span title="{% trans "Edit this post. All revisions are saved!" %}"  class="popup"><a href="{% url snapboard_edit_post top_post.id %}?next={{ request.get_full_path|urlencode }}" onclick="return toggle_edit('{{ top_post.id }}')">{% trans "edit post" %}</a></span>{% endifequal %}
                {% if user.is_staff %}<span title="{% trans "ADMIN: mark this post for censorship" %}" class="popup"><a id="censor{{ top_post.id }}" href="#snap_post{{ top_post.id }}" onclick="set_censor('{{ top_post.id }}');">{{ top_post.censor|yesno:_("uncensor,censor") }}</a></span>{% endif %}
                {% if user.is_authenticated and not top_post.freespeech %}<span title="{% trans "Report this post for violation of forum policies." %}" class="popup"><a id="abuse{{ top_post.id }}" href="#snap_post{{ top_post.id }}" onclick="set_abuse('{{ top_post.id }}');">{% trans "report abuse" %}</a></span>{% endif %}
            </span>
            
            <b><a href="#snap_post{{ top_post.id }}" onclick="toggle_post('{{ top_post.id }}');"><span class="popup" title="Author">{{ top_post.user }}</span></a></b>
            {% if top_post.private.all %}
                {% trans "to" %} {% for rec in top_post.private.all %}{{ rec }}{% if not forloop.last %},{% endif %}{% endfor %}
            {% endif %}
            <span class="timesince"><span class="datetime">{{ top_post.date|date:"r T" }}<span class="timestamp">{{ top_post.date|timestamp }}</span></span></span>
            <span class="post_summary" style="display:none;" id="snap_post_sum{{ top_post.id }}">:
                {{ top_post.text|post_summary:"30"|safe }}
            </span>
        </div>
        <div style="display:block" id="snap_post_view{{ top_post.id }}">
            <div class="post_text" style="display:block" id="snap_post_text{{ top_post.id }}">
                {{ top_post.text|striptags|render_post|safe }}
            </div>
            {% if top_post.previous %}
                <span id="post_revision_links{{ top_post.id }}" class="post_menuleft">
                  <a href="#snap_post_view{{ top_post.id }}" onclick="revision('{{ top_post.id }}','{{ top_post.previous.id }}');">{% trans "previous" %}</a>
                  <a href="{% url snapboard_show_revisions top_post.id %}">
                    <b style="color: #c00">{% trans "This message has been revised" %}</b></a></span> 
            {% endif %}
            {% ifequal top_post.user_id user.id %}
                <div style="display:none" id="snap_post_edit{{ top_post.id }}">
                    <form action="{% url snapboard_edit_post top_post.id %}" method="post">
                        <p><b>{% trans "All revisions of this post are stored and publicly viewable." %}</b></p>
                        <p>{{ top_post.get_edit_form.post }} {# TODO: what about errors? #}</p>
                        <p><input type="submit" value="{% trans "Update" %}" />
                          <input type="hidden" name="next" value="{{ request.path }}" />
                        </p>
                    </form>
                </div>
            {% endifequal %}
        </div>
        {% if top_post.censor %}</div>{% else %}{% ifnotequal top_post.abuse 0 %}</div>{% endifnotequal %}{% endif %}

</div>
</div>
{% autopaginate post_list user_settings.ppp %}
{% paginate %}
{% for top_answer in post_list %}
    {% for post, post_info in top_answer.get_flathelper_list %}

        {% if not post_info.open %}
        </div>
        {% endif %}

        {% if post.is_flat %}
        <div id="snap_post{{ post.id }}" class="snap_post flat_post">
        {% else %}
        <div id="snap_post{{ post.id }}" class="snap_post">
        {% if not post.next_sibling %}
        <div class="thread_crutch"></div>
        {% endif %}
        {% endif %}

           {% if post.censor %}{% if post.is_flat %}<div class="post_censored flat_color">{% else %}<div class="post_censored">{% endif %}{% else %}{% ifnotequal post.abuse 0 %}{% if post.is_flat %}<div class="post_reported flat_color">{% else %}<div class="post_reported">{% endif %}{% endifnotequal %}{% endif %}
           <div id="post_rpc_feedback{{ post.id }}" class="rpc_message">
               <!-- This DIV is for RPC feedback messages for individual posts -->
           </div>
           {% if post.is_flat %}<div class="post_header flat_header">{% else %}<div class="post_header">{% endif %}
               {% if post.is_flat %}{% else %}
               {% ifnotequal post.depth 2 %}
               <div class="thread_turn"></div>
               {% endifnotequal %}
               {% endif %}
               <div class="userpic_wrap">{% avatar post.user %}</div>
               <span class="post_menuright">
                   {% if user.is_authenticated and not user.really_anonymous %}
                       {% ifequal post.user_id user.id %}<span title="{% trans "Edit this post. All revisions are saved!" %}"  class="popup"><a href="{% url snapboard_edit_post post.id %}?next={{ request.get_full_path|urlencode }}%23snap_post{{ post.id }}" onclick="return toggle_edit('{{ post.id }}')">{% trans "edit post" %}</a></span>{% endifequal %}
                       <span class="popup"><a href="{% url snapboard_post_reply post.id %}" onclick="return toggle_reply('{{ post.id }}');">{% trans "reply" %}</a></span>
                       {% if not user.really_anonymous %}<span class="popup"><a id="watch{{ post.id }}" href="{% url snapboard_watch_post post.id %}?next={{ request.get_full_path|urlencode }}%23snap_post{{ post.id }}" onclick="set_watch('{{ post.id }}'); return false;">{% trans "toggle watch" %}</a></span>{% endif %}
                   {% endif %}
                   {% if user.is_staff %}<span title="{% trans "ADMIN: mark this post for censorship" %}" class="popup"><a id="censor{{ post.id }}" href="#snap_post{{ post.id }}" onclick="set_censor('{{ post.id }}');">{{ post.censor|yesno:_("uncensor,censor") }}</a></span>{% endif %}
                   {% if user.is_authenticated and not post.freespeech %}<span title="{% trans "Report this post for violation of forum policies." %}" class="popup"><a id="abuse{{ post.id }}" href="#snap_post{{ post.id }}" onclick="set_abuse('{{ post.id }}');">{% trans "report abuse" %}</a></span>{% endif %}
               </span>
               <b><a href="#snap_post{{ post.id }}" onclick="toggle_post('{{ post.id }}'); return false; r"><span class="popup" title="Author">{{ post.user }}</span></a></b>
               <span class="timesince"><span class="datetime">{{ post.date|date:"r T" }}<span class="timestamp">{{ post.date|timestamp }}</span></span></span>
               <span class="post_summary" style="display:none;" id="snap_post_sum{{ post.id }}">:
                {{ post.text|post_summary:"30"|safe }}
               </span>
            </div>
           <div id="snap_post_view{{ post.id }}" class="post_view">
               <div class="post_text" id="snap_post_text{{ post.id }}">
                   {{ post.text|striptags|render_post|safe }}
               </div>
               {% if post.previous %}
                   <span id="post_revision_links{{ post.id }}" class="post_menuleft">
                     <a href="#snap_post_view{{ post.id }}" onclick="revision('{{ post.id }}','{{ post.previous.id }}'); return false;">&#171; {% trans "previous" %}</a>
                     <a href="{% url snapboard_show_revisions post.id %}">
                       <b style="color: #c00">{% trans "This message has been revised" %}</b></a></span>
                   <br/>
               {% endif %}
               {% ifequal post.user_id user.id %}
                   <div style="display:none" id="snap_post_edit{{ post.id }}"></div>
               {% endifequal %}
           </div>
        
           <div style="display:none" id="snap_post_reply{{ post.id }}"></div>

           {% if post.censor %}</div>{% else %}{% ifnotequal post.abuse 0 %}</div>{% endifnotequal %}{% endif %}
        
        {% for close in post_info.close %}
            </div>
        {% endfor %}
    {% endfor %}
{% endfor %}            
    </div>
