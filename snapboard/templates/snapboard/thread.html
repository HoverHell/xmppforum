{% extends "snapboard/base_forum.html" %}

{% load extras %} {# also includes textile #}

{% block snapboard_main %}
    <div id="thread_rpc_msg_div" class="rpc_message">
        <!-- This DIV is for RPC feedback messages for the whole thread-->
    </div>
    <p>
        <span class="thread_menu">
            {% if user.is_staff %}
                <span>
                    <a id="csticky{{ thr.id }}" href="#" onClick="set_csticky('{{ thr.id }}');">
                        {{ thr.csticky|yesno:"unset,set" }} csticky
                    </a> 
                </span>
                &#149;
                <span>
                    <a id="gsticky{{ thr.id }}" href="#" onClick="set_gsticky('{{ thr.id }}');">
                        {{ thr.gsticky|yesno:"unset,set" }} gsticky
                    </a> 
                </span>
                &#149;
                <span>
                    <a id="close{{ thr.id }}" href="#" onClick="set_close('{{ thr.id }}');">
                        {{ thr.closed|yesno:"open,close" }} thread
                    </a> 
                </span>
            {% endif %}
            {% if user.is_authenticated %}
                &#149;
                <span>
                    <a id="watch{{ thr.id }}" href="#" onClick="set_watch('{{ thr.id }}');">
                        {{ watched|yesno:"don't," }} watch
                    </a> 
                </span>
            {% endif %}
        </span>
        <b style="font-size: large;">
            <a href="/snapboard/threads/category/{{ thr.category.id }}">{{ thr.category }}</a>:
            {{ thr.subject }}
        </b>
    </p>
    <br />

    {% include "snapboard/page_navigation.html" %}

    <div>
    <hr class="firstpost" />
    {% for post in post_page %}
        <div id="post_rpc_msg_div{{ post.id }}" class="rpc_message">
            <!-- This DIV is for RPC feedback messages for individual posts -->
        </div>
        <p class="post_header">
            <span class="post_menuright">
                {% ifequal post.user_id user.id %}
                <span title="Edit this post.  All revisions are saved!" class="popup">
                    <b><a href="#post{{ post.id }}" onclick="toggle_edit('{{ post.id }}')">edit post</a></b>
                </span>
                &#149;
                {% endifequal %}
                {% if user.is_staff %}
                <span title="ADMIN: mark this post for censorship" class="popup">
                    <a id="censor{{ post.id }}" href="#" onClick="set_censor('{{ post.id }}');">
                        {{ post.censor|yesno:"uncensor,censor" }}
                    </a>
                </span>
                
                {% endif %}
                {% if user.is_authenticated %}
                <span title="Report this post for violation of forum policies." class="popup">
                    <a id="abuse{{ post.id }}" href="#" onClick="set_abuse('{{ post.id }}');">&#149; report abuse</a>
                </span>
                {% endif %}
            </span>

            {% if post.avatar %}
                {# [ICON] #}
                <img src="/media/{{ post.avatar }}" />
            {% endif %}
            <b>
                <a href="#post{{ post.id }}" onclick="toggle_post('{{ post.id }}');">
                    <span title="POPUP" class="popup">{{ post.user }}</span>
                </a>
            </b>

            <span class="timesince">
                {{ post.date|timesince }} ago
            </span>
            <span class="post_summary" style="display:none;" id="sum{{ post.id }}">:
                {{ post.text|post_summary:"30" }}
            </span>
            {% if post.private %}
            <!-- TODO: filter out private posts -->
            to {{ post.private }}
            {% endif %}
        </p>

        <div style="display:block" id="post{{ post.id }}">
            <div class="post" style="display:block" id="post_text{{ post.id }}">
                {{ post.text|striptags|textile }}
            </div>
            {% if post.previous %}
            <span id="post_revision_links{{ post.id }}" class="post_menuleft">
                {# redirect is not possible here in the href property below since it resets the page #}
                {# need to do it w/ javascript #}
                <a href="#post{{ post.id }}" onClick="revision('{{ post.id }}','{{ post.previous.id }}');">&#171; previous</a>
                <b style="color: #c00">This message has been revised</b>
            </span>
            <br />
            {% endif %}

            {% ifequal post.user_id user.id %}
            <div style="display:none" id="post_edit{{ post.id }}">
                <form action="/snapboard/edit_post/{{ post.id }}/" method="POST">
                <b>All revisions of this post are stored and publicly viewable.</b>
                <p>{{ post.get_edit_form.post }} {# TODO: what about errors? #}</p>
                <input type="submit" value="Update">
                <input type="hidden" name="next" value="{{ request.path }}">
                </form>
            </div>
            {% endifequal %}
        </div>
        <br />
        <hr class="postend" />
    {% endfor %} {# iterate through posts #}
    </div>

    {% include "snapboard/page_navigation.html" %}
    <br />
    {% if not thr.closed and not page_next%}
        {% if user.is_authenticated %}
        <!-- div style="border: 1px solid #ccc; padding: 5px; background: #efe" -->
        <form id="add_post_div" action="" method="POST">
            <script type="text/javascript" src="/media/js/yui/yahoo-min.js"></script>
            <script type="text/javascript" src="/media/js/yui/dom-min.js"></script>
            <script type="text/javascript" src="/media/js/yui/event-min.js"></script>
            <script type="text/javascript" src="/media/js/yui/connection-min.js"></script>
            <script type="text/javascript" src="/media/js/yui/autocomplete-min.js"></script>
            Got something to say?
            <br />
            <p>{{ postform.post }} {{ postform.post.errors }}</p>
            <p id="autocomplete_p"><a href="#add_post_div" onClick="toggle('autocomplete_input', 'block'); toggle('autocomplete_p', 'inline');">set private recipients</a></p>
            <div id="autocomplete_input" style="display:none">
                <p>{{ postform.private }}{{ postform.private.errors }}</p>
                <div id="autocomplete_div" style="padding-right: 1em; position:absolute; z-index: 9000;  background-color:#cfc; color:#333; border: 1px solid black;"></div>
                <script type="text/javascript">
                    dataSource = new YAHOO.widget.DS_XHR("/snapboard/rpc/user_lookup/", ["ResultSet.Result","name","id"]);
                    autoComp = new YAHOO.widget.AutoComplete("id_private","autocomplete_div",dataSource);
                    autoComp.delimChar = ","; 
                    autoComp.typeAhead = true;
                    autoComp.highlightClassName = "highlight";
                </script>
            </div>

            <input type="submit" value="Post">
        </form>
        {% else %}
        <p>You need to <a href="/snapboard/signin/?next={{ request.path|urlencode }}#add_post_div">sign in</a> to post messages.</p>
        {% endif %}
    {% endif %}
    {% if thr.closed %}
        <p>This discussion has been closed by the staff.  You can no longer add posts.</p>
    {% endif %}

{% endblock %}
